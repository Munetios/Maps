<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Munetios Maps</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />
    <link rel="manifest" href="site.webmanifest" />
    <link
      rel="stylesheet"
      href="https://api.munetios.com/beautiful-css/beautiful.css"
    />
    <meta
      name="description"
      content="Munetios Maps - Explore the world with OpenStreetMap data and beautiful CSS styling."
    />
    <meta
      name="keywords"
      content="Munetios, Maps, OpenStreetMap, Beautiful CSS, Mapping, GIS"
    />
    <meta name="author" content="Munetios" />
    <meta property="og:title" content="Munetios Maps" />
    <meta
      property="og:description"
      content="Explore the world with OpenStreetMap data and beautiful CSS styling."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://maps.munetios.com" />
    <meta
      property="og:image"
      content="https://maps.munetios.com/android-chrome-192x192.png"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,wght,ROND@6..144,1..1000,90&amp;family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&amp;display=swap"
      rel="stylesheet"
    />
    <meta
      http-equiv="Content Security Policy"
      content="default-src 'self'; script-src 'self' https://unpkg.com 'nonce-hDhji4fidj43djd432'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://*.munetios.com https://*.openstreetmap.org; connect-src 'self' https://api.munetios.com https://nominatim.openstreetmap.org https://router.project-osrm.org; frame-src 'self' https://www.munetios.com;"
    />
    <style>
      html,
      body,
      button,
      input,
      select,
      textarea {
        font-family: "Google Sans Flex", sans-serif;
        font-variation-settings: "wght" 480, "GRAD" 30, "ROND" 80, "opsz" 18;
      }
      body {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .app {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .map-canvas {
        flex: 1;
        height: 100vh;
        width: 100%;
      }
      .munetios-footer {
        font-size: 0.875rem;
        text-align: center;
        padding: 1rem;
        position: absolute;
        left: 50%;
        bottom: 0;
        transform: translateX(-50%);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
        z-index: 10000000;
        box-sizing: border-box;
        width: auto;
        min-width: 300px;
        max-width: 90vw;
        white-space: nowrap;
      }
      a {
        color: inherit;
        text-decoration: underline;
      }
      munetios-right-panel .zoom-controls {
        flex-direction: column;
        display: flex;
        gap: 0.5rem;
        position: absolute;
        top: 100px;
        right: 1rem;
        z-index: 1000;
        padding: 10px;
      }
      munetios-right-panel .zoom-controls button {
        padding: 0;
        background: transparent;
        border: none;
        cursor: pointer;
      }
      .topbar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        box-sizing: border-box;
      }
      .menu-btn {
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
      }
      .topbar-left {
        display: flex;
        align-items: center;
        gap: 9px;
        width: 100%;
      }
      .search-bar {
        height: 48px;
        display: flex;
        align-items: center;
        padding: 0 1rem;
        gap: 0.5rem;
        max-width: 600px;
        width: 100%;
        box-sizing: border-box;
      }
      .search-bar input {
        width: 100%;
        height: 28px;
        font-size: 1rem;
      }
      .top-right {
        margin-left: auto;
        display: flex;
        align-items: center;
        height: 48px;
        width: auto;
        gap: 1rem;
        padding: 0 0.8rem;
      }
      button {
        all: unset;
        cursor: pointer;
      }
      input {
        all: unset;
        box-sizing: border-box;
      }
      @media (max-width: 900px) {
        .munetios-footer {
          width: 100%;
          max-width: 100vw;
        }
      }
      @media screen and (max-width: 768px) {
        .munetios-footer {
          font-size: 0.75rem;
          padding: 0.5rem;
        }
      }
      @media (max-width: 680px) {
        .munetios-footer {
          font-size: 0.6875rem;
          padding: 0.25rem;
          justify-content: flex-start;
          overflow-x: auto;
        }
      }
      .coordinates {
        display: flex;
        gap: 0.5rem;
        font-size: 0.875rem;
        white-space: nowrap;
      }
      .pan-controls {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 0.25rem;
        position: absolute;
        top: 200px;
        right: 1rem;
        padding: 10px;
        z-index: 999999999;
        margin-top: 0.5rem;
      }
      .pan-controls button {
        padding: 0;
        background: transparent;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .pan-controls button:nth-child(1) {
        grid-column: 2;
        grid-row: 1;
      }
      .pan-controls button:nth-child(2) {
        grid-column: 1;
        grid-row: 2;
      }
      .pan-controls button:nth-child(3) {
        grid-column: 3;
        grid-row: 2;
      }
      .pan-controls button:nth-child(4) {
        grid-column: 2;
        grid-row: 3;
      }
      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: rgba(255, 255, 255, 0.01) !important;
        backdrop-filter: blur(1.75px) saturate(180%) !important;
        border: 1px solid rgba(255, 255, 255, 0.18) !important;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37) !important;
        font-family: "Google Sans Flex", sans-serif !important;
      }
      .shelf-left {
        position: absolute;
        top: 90px;
        left: 1rem;
        z-index: 9999999999;
        padding: 10px;
        width: auto;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        height: calc(100vh - 170px);
        transform: translateX(0);
        transition: transform 0.3s ease-in-out;
      }
      .shelf-left:not(.active) {
        transform: translateX(-200%);
        pointer-events: none;
      }
      .shelf-left.active {
        transform: translateX(0);
        pointer-events: auto;
      }
      .shelf-left button {
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        box-sizing: border-box;
        transition: background-color 0.3s, border-radius 0.3s;
      }
      .shelf-left button:hover {
        background-color: rgba(255, 255, 255, 0.4);
        border-radius: 12px;
      }
      .search-results {
        display: none;
        flex-direction: column;
        gap: 0.5rem;
        max-height: 300px;
        overflow-y: auto;
      }
      .search-results.active {
        display: flex;
      }
      .search-result-item {
        padding: 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.875rem;
      }
      .search-result-item:hover {
        background-color: rgba(255, 255, 255, 0.3);
      }
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 99999999999;
        align-items: center;
        justify-content: center;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal-content {
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 1.5rem;
        border-radius: 16px;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
      }
      .modal-close {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
      }
      .modal-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      .marker-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .marker-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
      }
      .marker-item:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .marker-info {
        flex: 1;
        cursor: pointer;
      }
      .marker-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      .marker-coords {
        font-size: 0.75rem;
        opacity: 0.8;
      }
      .marker-delete {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        color: #f44336;
      }
      .marker-delete:hover {
        background: rgba(244, 67, 54, 0.1);
      }
      .add-marker-btn {
        width: 100%;
        padding: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        border-radius: 8px;
        background: rgba(33, 150, 243, 0.2);
        transition: background-color 0.2s;
      }
      .add-marker-btn:hover {
        background: rgba(33, 150, 243, 0.3);
      }
      .directions-panel {
        display: none;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1rem;
      }
      .directions-panel.active {
        display: flex;
      }
      .transport-modes {
        display: flex;
        gap: 0.5rem;
      }
      .transport-mode {
        flex: 1;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        transition: background-color 0.2s;
        font-size: 0.75rem;
      }
      .transport-mode.active {
        background: rgba(33, 150, 243, 0.3);
      }
      .transport-mode:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .direction-input {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
      }
      .direction-input input {
        flex: 1;
        padding: 0.5rem;
        background: transparent;
      }
      .direction-controls {
        display: flex;
        gap: 0.5rem;
      }
      .direction-btn {
        flex: 1;
        padding: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        border-radius: 8px;
        transition: background-color 0.2s;
      }
      .direction-btn.start {
        background: rgba(76, 175, 80, 0.3);
      }
      .direction-btn.start:hover {
        background: rgba(76, 175, 80, 0.4);
      }
      .direction-btn.stop {
        background: rgba(244, 67, 54, 0.3);
      }
      .direction-btn.stop:hover {
        background: rgba(244, 67, 54, 0.4);
      }
      .turns-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .turn-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        font-size: 0.875rem;
      }
      .turn-icon {
        color: #6021f3;
      }
      .turn-text {
        flex: 1;
      }
      .turn-distance {
        font-size: 0.75rem;
        opacity: 0.7;
        white-space: nowrap;
      }
      .panel-section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .panel-section-title {
        font-size: 0.875rem;
        font-weight: 600;
        opacity: 0.8;
        margin-bottom: 0.25rem;
      }
      .add-marker-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 99999999999;
        align-items: center;
        justify-content: center;
      }
      .add-marker-modal.active {
        display: flex;
      }
      .add-marker-content {
        width: 90%;
        max-width: 400px;
        padding: 1.5rem;
        border-radius: 16px;
      }
      .modal-input {
        width: 100%;
        padding: 0.75rem;
        margin: 1rem 0;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 1rem;
      }
      .modal-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
      }
      .modal-btn {
        flex: 1;
        padding: 0.75rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: background-color 0.2s;
      }
      .modal-btn.primary {
        background: rgba(114, 33, 243, 0.3);
      }
      .modal-btn.primary:hover {
        background: rgba(96, 33, 243, 0.4);
      }
      .modal-btn.secondary {
        background: rgba(255, 255, 255, 0.1);
      }
      .modal-btn.secondary:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .directions-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        border-radius: 8px;
        background: rgba(33, 150, 243, 0.2);
        margin-bottom: 1rem;
      }
      .directions-info {
        flex: 1;
      }
      .directions-duration {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      .directions-arrival {
        font-size: 0.75rem;
        opacity: 0.8;
      }
      .directions-controls-right {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .voice-toggle {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        transition: background-color 0.2s;
      }
      .voice-toggle.active {
        background: rgba(76, 175, 80, 0.3);
        color: #4caf50;
      }
      .voice-toggle:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .stop-directions-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(244, 67, 54, 0.3);
        transition: background-color 0.2s;
      }
      .stop-directions-btn:hover {
        background: rgba(244, 67, 54, 0.4);
      }
      @media (max-width: 600px) {
        .coordinates {
          display: none !important;
        }
        .shelf-left {
          position: fixed;
          left: 0;
          bottom: 45px;
          top: auto;
          width: 100vw;
          height: auto;
          max-height: 400px;
          gap: 0.25rem;
          z-index: 9999999999;
          padding: 0.5rem 0.5rem;
          box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.08);
          overflow-x: auto;
          overflow-y: visible;
          transform: translateY(0);
          transition: transform 0.3s ease-in-out;
        }
        .shelf-left:not(.active) {
          transform: translateY(1000%);
          pointer-events: none;
        }
        .shelf-left.active {
          transform: translateY(0);
          pointer-events: auto;
        }
        .shelf-left button {
          min-width: 100px;
          flex: 1 1 auto;
          justify-content: center;
          padding: 0.5rem 0.5rem;
        }
      }
      .context-menu {
        display: none;
        position: fixed;
        z-index: 999999999999;
        min-width: 200px;
        padding: 0.5rem 0;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }
      .context-menu.active {
        display: block;
      }
      .context-menu-item {
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.9rem;
      }
      .context-menu-item:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .context-menu-item:first-child {
        border-radius: 12px 12px 0 0;
      }
      .context-menu-item:last-child {
        border-radius: 0 0 12px 12px;
      }
      .context-menu-separator {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 0.25rem 0;
      }
      .share-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 99999999999;
        align-items: center;
        justify-content: center;
      }
      .share-modal.active {
        display: flex;
      }
      .share-content {
        width: 90%;
        max-width: 400px;
        padding: 1.5rem;
        border-radius: 16px;
      }
      .share-options {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
      }
      .share-option {
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .share-option:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .share-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }
      .share-icon.facebook {
        background: #1877f2;
      }
      .share-icon.whatsapp {
        background: #25d366;
      }
      .share-icon.gmail {
        background: #ea4335;
      }
      .share-icon.link {
        background: #6021f3;
      }
      .embed-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 99999999999;
        align-items: center;
        justify-content: center;
      }
      .embed-modal.active {
        display: flex;
      }
      .embed-content {
        width: 90%;
        max-width: 500px;
        padding: 1.5rem;
        border-radius: 16px;
      }
      .embed-code {
        width: 100%;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-family: monospace;
        font-size: 0.85rem;
        resize: vertical;
        min-height: 120px;
      }
      .language-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
      }
      .language-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .language-item:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .language-item.active {
        background: rgba(96, 33, 243, 0.3);
      }
      .language-name {
        font-size: 1rem;
        font-weight: 500;
      }
      .language-check {
        opacity: 0;
        color: #4caf50;
      }
      .language-item.active .language-check {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <munetios-app id="app" class="app main-app" _ng-content-random>
      <div id="shadow-root" _ng-content-random class="root">
        <div class="map-canvas" id="map" _ng-content-random></div>
      </div>
      <header
        class="topbar"
        id="topbar"
        _ng-content-random
        database="munetios-topbar"
      >
        <div class="topbar-left" _ng-content-random>
          <div class="menu-btn liquid-glass" id="menuBtn" _ng-content-random>
            <span class="material-symbols-rounded">menu</span>
          </div>
          <div class="search-bar liquid-glass">
            <span class="material-symbols-rounded" _ng-content-random
              >search</span
            >
            <input
              type="text"
              id="searchInput"
              _ng-content-random
              placeholder="Search Places, Addresses, Restaurants"
              aria-label="Search Places, Addresses, Restaurants"
            />
            <span
              id="micIcon"
              class="material-symbols-rounded"
              _ng-content-random
              title="Voice Search"
              aria-label="Voice Search"
              >mic</span
            >
          </div>
        </div>
        <div class="top-right liquid-glass">
          <div class="coordinates">
            <span id="lat" _ng-content-random>X: --</span>
            <span id="lng" _ng-content-random>Y: --</span>
          </div>
          <div class="use-my-location-btn">
            <button
              id="useMyLocationBtn"
              _ng-content-random
              title="Use My Location"
              aria-label="Use My Location"
            >
              <span class="material-symbols-rounded">my_location</span>
            </button>
          </div>
          <div class="bookmarks-btn-wrapper">
            <button
              id="bookmarksBtn"
              _ng-content-random
              title="Bookmarks"
              aria-label="Bookmarks"
              style="position: relative"
            >
              <span class="material-symbols-rounded">bookmark</span>
            </button>
          </div>
          <div class="settings-btn-wrapper">
            <button
              id="settingsBtn"
              _ng-content-random
              title="Settings"
              aria-label="Settings"
            >
              <span class="material-symbols-rounded">settings</span>
            </button>
          </div>
        </div>
      </header>
      <munetios-left-panel>
        <div
          class="shelf-left active liquid-glass"
          id="leftPanel"
          _ng-content-random
          database="munetios-leftpanel"
        >
          <button
            id="directionsBtn"
            _ng-content-random
            title="Directions"
            aria-label="Directions"
          >
            <span class="material-symbols-rounded" _ng-content-random
              >directions</span
            >
            <span _ng-content-random data-i18n="directions">Directions</span>
          </button>
          <button
            id="markersBtn"
            _ng-content-random
            title="Markers"
            aria-label="Markers"
          >
            <span class="material-symbols-rounded" _ng-content-random
              >place</span
            >
            <span _ng-content-random data-i18n="markers">Markers</span>
          </button>
          <div class="search-results" id="searchResults" _ng-content-random>
            <!-- Search results will be populated here -->
          </div>
          <div class="directions-panel" id="directionsPanel" _ng-content-random>
            <div class="panel-section">
              <div class="panel-section-title">Transport Mode</div>
              <div class="transport-modes">
                <button class="transport-mode active" data-mode="driving">
                  <span class="material-symbols-rounded">directions_car</span>
                  <span>Drive</span>
                </button>
                <button class="transport-mode" data-mode="walking">
                  <span class="material-symbols-rounded">directions_walk</span>
                  <span>Walk</span>
                </button>
                <button class="transport-mode" data-mode="cycling">
                  <span class="material-symbols-rounded">directions_bike</span>
                  <span>Bike</span>
                </button>
              </div>
            </div>
            <div class="panel-section">
              <div class="direction-input">
                <span class="material-symbols-rounded">trip_origin</span>
                <input
                  type="text"
                  id="fromInput"
                  placeholder="Starting point"
                />
              </div>
              <div class="direction-input">
                <span class="material-symbols-rounded">location_on</span>
                <input type="text" id="toInput" placeholder="Destination" />
              </div>
            </div>
            <div class="direction-controls">
              <button class="direction-btn start" id="startDirectionsBtn">
                <span class="material-symbols-rounded">play_arrow</span>
                <span data-i18n="start">Start</span>
              </button>
              <button
                class="direction-btn"
                id="feelingLuckyBtn"
                style="background: rgba(255, 193, 7, 0.3)"
              >
                <span class="material-symbols-rounded">casino</span>
                <span data-i18n="feelingLucky">I'm Feeling Lucky</span>
              </button>
            </div>
            <div
              class="directions-header"
              id="directionsHeader"
              style="display: none"
            >
              <div class="directions-info">
                <div class="directions-duration" id="directionsDuration">
                  -- min
                </div>
                <div class="directions-arrival" id="directionsArrival">
                  Arrival: --:--
                </div>
              </div>
              <div class="directions-controls-right">
                <button
                  class="voice-toggle active"
                  id="voiceToggle"
                  title="Voice guidance"
                >
                  <span class="material-symbols-rounded">volume_up</span>
                </button>
                <button
                  class="stop-directions-btn"
                  id="stopDirectionsBtn"
                  title="Stop navigation"
                >
                  <span class="material-symbols-rounded">close</span>
                </button>
              </div>
            </div>
            <div class="turns-list" id="turnsList">
              <!-- Turn-by-turn directions will be populated here -->
            </div>
          </div>
        </div>
      </munetios-left-panel>
      <munetios-right-panel
        id="rightPanel"
        _ng-content-random
        database="munetios-rightpanel"
        class="right-panel shelf-right"
      >
        <div
          class="zoom-controls liquid-glass"
          id="zoomControls"
          _ng-content-random
        >
          <button
            class="zoom-in-button"
            id="zoomInButton"
            _ng-content-random
            title="Zoom in"
            aria-label="Zoom In"
          >
            <span class="material-symbols-rounded">add</span>
          </button>
          <button
            class="zoom-out-button"
            id="zoomOutButton"
            _ng-content-random
            title="Zoom Out"
            aria-label="Zoom Out"
          >
            <span class="material-symbols-rounded">remove</span>
          </button>
        </div>
        <div
          class="pan-controls liquid-glass"
          id="panControls"
          _ng-content-random
        >
          <button
            id="panNorthBtn"
            _ng-content-random
            title="Pan North"
            aria-label="Pan North"
          >
            <span class="material-symbols-rounded">arrow_upward</span>
          </button>
          <button
            id="panWestBtn"
            _ng-content-random
            title="Pan West"
            aria-label="Pan West"
          >
            <span class="material-symbols-rounded">arrow_back</span>
          </button>
          <button
            id="panEastBtn"
            _ng-content-random
            title="Pan East"
            aria-label="Pan East"
          >
            <span class="material-symbols-rounded">arrow_forward</span>
          </button>
          <button
            id="panSouthBtn"
            _ng-content-random
            title="Pan South"
            aria-label="Pan South"
          >
            <span class="material-symbols-rounded">arrow_downward</span>
          </button>
        </div>
      </munetios-right-panel>
      <footer class="munetios-footer liquid-glass" id="footer">
        Map data ¬©
        <a
          href="https://www.openstreetmap.org/copyright"
          target="_blank"
          rel="noopener"
          >OpenStreetMap</a
        >
        contributors | &copy;2026 Munetios&trade; |
        <a
          href="https://www.munetios.com/policies/#/terms"
          target="_self"
          rel="noopener"
          >Terms of Service</a
        >
        |
        <a
          href="https://www.munetios.com/policies/#/privacy"
          target="_self"
          rel="noopener"
          >Privacy Policy</a
        >
      </footer>
    </munetios-app>
    <!-- Context Menu -->
    <div class="context-menu liquid-glass" id="contextMenu">
      <div class="context-menu-item" id="shareLocation">
        <span class="material-symbols-rounded">share</span>
        <span>Share</span>
      </div>
      <div class="context-menu-item" id="embedMap">
        <span class="material-symbols-rounded">code</span>
        <span>Embed</span>
      </div>
      <div class="context-menu-item" id="bookmarkLocation">
        <span class="material-symbols-rounded">bookmark</span>
        <span>Bookmark</span>
      </div>
      <div class="context-menu-separator"></div>
      <div class="context-menu-item" id="directionsFromHere">
        <span class="material-symbols-rounded">navigation</span>
        <span>Directions from here</span>
      </div>
      <div class="context-menu-item" id="directionsToHere">
        <span class="material-symbols-rounded">place</span>
        <span>Directions to here</span>
      </div>
    </div>
    <!-- Share Modal -->
    <div class="share-modal" id="shareModal">
      <div class="share-content liquid-glass">
        <div class="modal-header">
          <h2>Share Location</h2>
          <button class="modal-close" id="closeShareModal">
            <span class="material-symbols-rounded">close</span>
          </button>
        </div>
        <div class="share-options">
          <div class="share-option" id="shareFacebook">
            <div class="share-icon facebook">f</div>
            <div>
              <div style="font-weight: 600">Facebook</div>
              <div style="font-size: 0.8rem; opacity: 0.7">
                Share on Facebook
              </div>
            </div>
          </div>
          <div class="share-option" id="shareWhatsApp">
            <div class="share-icon whatsapp">üí¨</div>
            <div>
              <div style="font-weight: 600">WhatsApp</div>
              <div style="font-size: 0.8rem; opacity: 0.7">
                Share via WhatsApp
              </div>
            </div>
          </div>
          <div class="share-option" id="shareGmail">
            <div class="share-icon gmail">‚úâ</div>
            <div>
              <div style="font-weight: 600">Gmail</div>
              <div style="font-size: 0.8rem; opacity: 0.7">Share via email</div>
            </div>
          </div>
          <div class="share-option" id="copyLink">
            <div class="share-icon link">
              <span class="material-symbols-rounded">link</span>
            </div>
            <div>
              <div style="font-weight: 600">Copy Link</div>
              <div style="font-size: 0.8rem; opacity: 0.7">
                Copy location link
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Embed Modal -->
    <div class="embed-modal" id="embedModal">
      <div class="embed-content liquid-glass">
        <div class="modal-header">
          <h2>Embed Map</h2>
          <button class="modal-close" id="closeEmbedModal">
            <span class="material-symbols-rounded">close</span>
          </button>
        </div>
        <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem">
          Copy the code below to embed this map on your website:
        </p>
        <textarea class="embed-code" id="embedCode" readonly></textarea>
        <button
          class="modal-btn primary"
          id="copyEmbedCode"
          style="width: 100%"
        >
          <span class="material-symbols-rounded">content_copy</span>
          <span>Copy Code</span>
        </button>
      </div>
    </div>
    <!-- Add Marker Modal -->
    <div class="add-marker-modal" id="addMarkerModal">
      <div class="add-marker-content liquid-glass">
        <div class="modal-header">
          <h2 data-i18n="addMarker">Add Marker</h2>
        </div>
        <input
          type="text"
          id="markerNameInput"
          class="modal-input"
          placeholder="Enter marker name"
        />
        <div class="modal-actions">
          <button class="modal-btn secondary" id="cancelAddMarker">
            <span class="material-symbols-rounded">close</span>
            <span data-i18n="cancel">Cancel</span>
          </button>
          <button class="modal-btn primary" id="confirmAddMarker">
            <span class="material-symbols-rounded">check</span>
            <span data-i18n="add">Add</span>
          </button>
        </div>
      </div>
    </div>
    <!-- Markers Modal -->
    <div class="modal-overlay" id="markersModal">
      <div class="modal-content liquid-glass">
        <div class="modal-header">
          <h2 data-i18n="myMarkers">My Markers</h2>
          <button class="modal-close" id="closeMarkersModal">
            <span class="material-symbols-rounded">close</span>
          </button>
        </div>
        <div class="marker-list" id="markerList">
          <!-- Markers will be populated here -->
        </div>
        <button class="add-marker-btn" id="addMarkerBtn">
          <span class="material-symbols-rounded">add_location</span>
          <span data-i18n="addMarkerAtLocation"
            >Add Marker at Current Location</span
          >
        </button>
      </div>
    </div>
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
      <div class="modal-content liquid-glass">
        <div class="modal-header">
          <h2 data-i18n="settings">Settings</h2>
          <button class="modal-close" id="closeSettingsModal">
            <span class="material-symbols-rounded">close</span>
          </button>
        </div>
        <div class="panel-section" style="margin-bottom: 1.5rem">
          <div class="panel-section-title" data-i18n="language">Language</div>
          <button
            id="selectLanguageBtn"
            class="modal-input"
            style="
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 0.75rem;
            "
          >
            <span id="currentLanguageText">English</span>
            <span class="material-symbols-rounded">arrow_forward_ios</span>
          </button>
        </div>
        <button
          class="modal-btn secondary"
          id="deleteAllMarkersBtn"
          style="width: 100%; background: rgba(244, 67, 54, 0.3)"
        >
          <span class="material-symbols-rounded">delete_forever</span>
          <span data-i18n="deleteAllMarkers">Delete All Markers</span>
        </button>
      </div>
    </div>
    <!-- Bookmarks Modal -->
    <div class="modal-overlay" id="bookmarksModal">
      <div class="modal-content liquid-glass">
        <div class="modal-header">
          <h2 data-i18n="bookmarks">Bookmarks</h2>
          <button class="modal-close" id="closeBookmarksModal">
            <span class="material-symbols-rounded">close</span>
          </button>
        </div>
        <div class="marker-list" id="bookmarkList">
          <!-- Bookmarks will be populated here -->
        </div>
      </div>
    </div>
    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="confirmDeleteModal">
      <div class="add-marker-content liquid-glass">
        <div class="modal-header">
          <h2 data-i18n="confirmDelete">Confirm Delete</h2>
        </div>
        <p
          style="margin: 1rem 0; opacity: 0.9"
          data-i18n="deleteAllMarkersConfirm"
        >
          Are you sure you want to delete all markers? This action cannot be
          undone.
        </p>
        <div class="modal-actions">
          <button class="modal-btn secondary" id="cancelDeleteAll">
            <span class="material-symbols-rounded">close</span>
            <span data-i18n="cancel">Cancel</span>
          </button>
          <button
            class="modal-btn"
            id="confirmDeleteAll"
            style="background: rgba(244, 67, 54, 0.3)"
          >
            <span class="material-symbols-rounded">delete_forever</span>
            <span data-i18n="deleteAll">Delete All</span>
          </button>
        </div>
      </div>
    </div>
    <!-- Language Selection Modal -->
    <div class="modal-overlay" id="languageModal">
      <div class="modal-content liquid-glass">
        <div class="modal-header">
          <h2 data-i18n="selectLanguage">Select Language</h2>
          <button class="modal-close" id="closeLanguageModal">
            <span class="material-symbols-rounded">close</span>
          </button>
        </div>
        <div class="language-list" id="languageList">
          <div class="language-item" data-lang="en">
            <span class="language-name">English</span>
            <span class="material-symbols-rounded language-check">check</span>
          </div>
          <div class="language-item" data-lang="es">
            <span class="language-name">Espa√±ol</span>
            <span class="material-symbols-rounded language-check">check</span>
          </div>
          <div class="language-item" data-lang="fr">
            <span class="language-name">Fran√ßais</span>
            <span class="material-symbols-rounded language-check">check</span>
          </div>
          <div class="language-item" data-lang="de">
            <span class="language-name">Deutsch</span>
            <span class="material-symbols-rounded language-check">check</span>
          </div>
          <div class="language-item" data-lang="it">
            <span class="language-name">Italiano</span>
            <span class="material-symbols-rounded language-check">check</span>
          </div>
          <div class="language-item" data-lang="pt">
            <span class="language-name">Portugu√™s</span>
            <span class="material-symbols-rounded language-check">check</span>
          </div>
          <div class="language-item" data-lang="ja">
            <span class="language-name">Êó•Êú¨Ë™û</span>
            <span class="material-symbols-rounded language-check">check</span>
          </div>
          <div class="language-item" data-lang="zh">
            <span class="language-name">‰∏≠Êñá</span>
            <span class="material-symbols-rounded language-check">check</span>
          </div>
          <div class="language-item" data-lang="ar">
            <span class="language-name">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span>
            <span class="material-symbols-rounded language-check">check</span>
          </div>
          <div class="language-item" data-lang="hi">
            <span class="language-name">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</span>
            <span class="material-symbols-rounded language-check">check</span>
          </div>
        </div>
      </div>
    </div>
    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script nonce="hDhji4fidj43djd432">
      // Zoom controls functionality
      document
        .getElementById("zoomInButton")
        .addEventListener("click", function () {
          map.zoomIn();
        });
      document
        .getElementById("zoomOutButton")
        .addEventListener("click", function () {
          map.zoomOut();
        });

      // Pan controls functionality
      const panAmount = 0.1; // Fraction of map height/width to pan
      document
        .getElementById("panNorthBtn")
        .addEventListener("click", function () {
          map.panBy([0, -map.getSize().y * panAmount]);
        });
      document
        .getElementById("panSouthBtn")
        .addEventListener("click", function () {
          map.panBy([0, map.getSize().y * panAmount]);
        });
      document
        .getElementById("panWestBtn")
        .addEventListener("click", function () {
          map.panBy([-map.getSize().x * panAmount, 0]);
        });
      document
        .getElementById("panEastBtn")
        .addEventListener("click", function () {
          map.panBy([map.getSize().x * panAmount, 0]);
        });
      // Initialize the map
      let isEmbedMode = false;
      let initialLat = 20;
      let initialLng = 0;
      let initialZoom = 2;

      // Parse URL hash for position (#lat,lng,zoom or #embed)
      function parseUrlHash() {
        const hash = window.location.hash.substring(1);
        if (hash === "embed") {
          isEmbedMode = true;
          return;
        }
        if (hash) {
          const parts = hash.split(",");
          if (parts.length >= 2) {
            initialLat = parseFloat(parts[0]);
            initialLng = parseFloat(parts[1]);
            if (parts.length >= 3) {
              const zoomPart = parts[2].replace("z", "");
              initialZoom = parseInt(zoomPart) || 2;
            }
          }
        }
      }

      // Update URL hash when map moves
      function updateUrlHash() {
        if (isEmbedMode) return;
        const center = map.getCenter();
        const zoom = map.getZoom();
        const hash = `#${center.lat.toFixed(5)},${center.lng.toFixed(
          5
        )},${zoom}z`;
        window.history.replaceState(null, null, hash);
      }

      parseUrlHash();

      const map = L.map("map", { attributionControl: false }).setView(
        [initialLat, initialLng],
        initialZoom
      );
      // Add OpenStreetMap tile layer
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 50,
        minZoom: 3,
      }).addTo(map);

      // Update URL hash on map move (debounced)
      let hashUpdateTimeout;
      map.on("moveend", () => {
        clearTimeout(hashUpdateTimeout);
        hashUpdateTimeout = setTimeout(updateUrlHash, 300);
      });

      // Handle embed mode
      if (isEmbedMode) {
        document.getElementById("topbar").style.display = "none";
        document.getElementById("leftPanel").style.display = "none";
        document.getElementById("rightPanel").style.display = "none";
        document.getElementById("footer").style.display = "none";
      }

      // Menu button toggle for left panel
      const menuBtn = document.getElementById("menuBtn");
      const leftPanel = document.getElementById("leftPanel");

      if (menuBtn && leftPanel) {
        menuBtn.addEventListener("click", () => {
          leftPanel.classList.toggle("active");
        });
      }

      // Remove zoom controls
      map.zoomControl.remove();

      // Rate limiting system (15 actions per 5 minutes)
      const RATE_LIMIT_MAX = 15;
      const RATE_LIMIT_WINDOW = 5 * 60 * 1000; // 5 minutes in milliseconds
      const RATE_LIMIT_KEY = "munetios-maps-rate-limit";

      function getRateLimitData() {
        const data = sessionStorage.getItem(RATE_LIMIT_KEY);
        if (!data) return { actions: [], blocked: false };
        return JSON.parse(data);
      }

      function saveRateLimitData(data) {
        sessionStorage.setItem(RATE_LIMIT_KEY, JSON.stringify(data));
      }

      function checkRateLimit(actionType) {
        // Check if captcha has been solved
        const captchaSolved = sessionStorage.getItem("submitedCaptcha");
        if (captchaSolved === "true") {
          return true; // Allow action if captcha is solved
        }

        const now = Date.now();
        const data = getRateLimitData();

        // Remove actions older than the time window
        data.actions = data.actions.filter(
          (timestamp) => now - timestamp < RATE_LIMIT_WINDOW
        );

        // Check if limit exceeded
        if (data.actions.length >= RATE_LIMIT_MAX) {
          data.blocked = true;
          saveRateLimitData(data);
          window.location.href = "429.html";
          return false;
        }

        // Add new action
        data.actions.push(now);
        saveRateLimitData(data);
        return true;
      }

      // Track page load
      checkRateLimit("page_load");

      // Context menu functionality
      const contextMenu = document.getElementById("contextMenu");
      const shareModal = document.getElementById("shareModal");
      const embedModal = document.getElementById("embedModal");
      let contextMenuLat = 0;
      let contextMenuLng = 0;

      // Show context menu on right-click
      map.on("contextmenu", (e) => {
        e.originalEvent.preventDefault();
        contextMenuLat = e.latlng.lat;
        contextMenuLng = e.latlng.lng;

        contextMenu.style.left = e.originalEvent.pageX + "px";
        contextMenu.style.top = e.originalEvent.pageY + "px";
        contextMenu.classList.add("active");
      });

      // Hide context menu on click anywhere
      document.addEventListener("click", () => {
        contextMenu.classList.remove("active");
      });

      // Share location
      document
        .getElementById("shareLocation")
        .addEventListener("click", (e) => {
          e.stopPropagation();
          shareModal.classList.add("active");
          contextMenu.classList.remove("active");
        });

      // Directions from here
      document
        .getElementById("directionsFromHere")
        .addEventListener("click", async (e) => {
          e.stopPropagation();
          contextMenu.classList.remove("active");

          // Activate directions panel
          directionsPanel.classList.add("active");
          searchResults.classList.remove("active");

          // Set from input with reverse geocoding
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${contextMenuLat}&lon=${contextMenuLng}`
            );
            const data = await response.json();
            fromInput.value =
              data.display_name ||
              `${contextMenuLat.toFixed(5)}, ${contextMenuLng.toFixed(5)}`;

            // Update from marker
            if (fromMarker) map.removeLayer(fromMarker);
            fromMarker = L.marker([contextMenuLat, contextMenuLng], {
              draggable: true,
              icon: L.divIcon({
                html: '<div style="background: #4CAF50; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">A</div>',
                className: "",
                iconSize: [30, 30],
              }),
            }).addTo(map);

            fromMarker.on("dragend", async function () {
              const pos = fromMarker.getLatLng();
              const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lng}`
              );
              const data = await response.json();
              fromInput.value =
                data.display_name ||
                `${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`;
            });
          } catch (error) {
            fromInput.value = `${contextMenuLat.toFixed(
              5
            )}, ${contextMenuLng.toFixed(5)}`;
          }
        });

      // Directions to here
      document
        .getElementById("directionsToHere")
        .addEventListener("click", async (e) => {
          e.stopPropagation();
          contextMenu.classList.remove("active");

          // Activate directions panel
          directionsPanel.classList.add("active");
          searchResults.classList.remove("active");

          // Set to input with reverse geocoding
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${contextMenuLat}&lon=${contextMenuLng}`
            );
            const data = await response.json();
            toInput.value =
              data.display_name ||
              `${contextMenuLat.toFixed(5)}, ${contextMenuLng.toFixed(5)}`;

            // Update to marker
            if (toMarker) map.removeLayer(toMarker);
            toMarker = L.marker([contextMenuLat, contextMenuLng], {
              draggable: true,
              icon: L.divIcon({
                html: '<div style="background: #F44336; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">B</div>',
                className: "",
                iconSize: [30, 30],
              }),
            }).addTo(map);

            toMarker.on("dragend", async function () {
              const pos = toMarker.getLatLng();
              const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lng}`
              );
              const data = await response.json();
              toInput.value =
                data.display_name ||
                `${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`;
            });
          } catch (error) {
            toInput.value = `${contextMenuLat.toFixed(
              5
            )}, ${contextMenuLng.toFixed(5)}`;
          }
        });

      // Embed map
      document.getElementById("embedMap").addEventListener("click", (e) => {
        e.stopPropagation();
        contextMenu.classList.remove("active");

        // Get current zoom level
        const zoom = map.getZoom();

        // Generate embed code with dynamic domain
        const domain = window.location.origin;
        const embedCode = `<iframe src="${domain}/#embed&${contextMenuLat},${contextMenuLng},${zoom}z" width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;

        // Set embed code in textarea
        document.getElementById("embedCode").value = embedCode;

        // Show embed modal
        embedModal.classList.add("active");
      });

      // Share modal functionality
      document
        .getElementById("closeShareModal")
        .addEventListener("click", () => {
          shareModal.classList.remove("active");
        });

      shareModal.addEventListener("click", (e) => {
        if (e.target === shareModal) {
          shareModal.classList.remove("active");
        }
      });

      document.getElementById("shareFacebook").addEventListener("click", () => {
        const domain = window.location.origin;
        const url = `${domain}/#${contextMenuLat},${contextMenuLng},15z`;
        const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(
          url
        )}`;
        window.open(shareUrl, "_blank", "width=600,height=400");
        shareModal.classList.remove("active");
      });

      document.getElementById("shareWhatsApp").addEventListener("click", () => {
        const domain = window.location.origin;
        const url = `${domain}/#${contextMenuLat},${contextMenuLng},15z`;
        const text = `Check out this location: ${url}`;
        const shareUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
        window.open(shareUrl, "_blank");
        shareModal.classList.remove("active");
      });

      document.getElementById("shareGmail").addEventListener("click", () => {
        const domain = window.location.origin;
        const url = `${domain}/#${contextMenuLat},${contextMenuLng},15z`;
        const subject = "Location from Munetios Maps";
        const body = `I wanted to share this location with you:\n\n${url}\n\nCoordinates: ${contextMenuLat.toFixed(
          5
        )}, ${contextMenuLng.toFixed(5)}`;
        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&su=${encodeURIComponent(
          subject
        )}&body=${encodeURIComponent(body)}`;
        window.open(gmailUrl, "_blank");
        shareModal.classList.remove("active");
      });

      document
        .getElementById("copyLink")
        .addEventListener("click", async () => {
          const domain = window.location.origin;
          const url = `${domain}/#${contextMenuLat},${contextMenuLng},15z`;
          try {
            await navigator.clipboard.writeText(url);
            showtoast("Link copied to clipboard!");
          } catch (err) {
            showtoast("Failed to copy link");
          }
          shareModal.classList.remove("active");
        });

      // Embed modal functionality
      document
        .getElementById("closeEmbedModal")
        .addEventListener("click", () => {
          embedModal.classList.remove("active");
        });

      embedModal.addEventListener("click", (e) => {
        if (e.target === embedModal) {
          embedModal.classList.remove("active");
        }
      });

      document
        .getElementById("copyEmbedCode")
        .addEventListener("click", async () => {
          const embedCode = document.getElementById("embedCode");
          try {
            await navigator.clipboard.writeText(embedCode.value);
            showtoast("Embed code copied to clipboard!");
          } catch (err) {
            embedCode.select();
            document.execCommand("copy");
            showtoast("Embed code copied!");
          }
        });
      function updateCoordinatesDisplay(lat, lng) {
        document.getElementById("lat").textContent = `X: ${lat.toFixed(5)}`;
        document.getElementById("lng").textContent = `Y: ${lng.toFixed(5)}`;
      }

      // Update coordinates on map move
      map.on("move", function () {
        const center = map.getCenter();
        updateCoordinatesDisplay(center.lat, center.lng);
      });

      // Initialize with current center
      const initialCenter = map.getCenter();
      updateCoordinatesDisplay(initialCenter.lat, initialCenter.lng);

      // Check for query parameter on load
      setTimeout(() => checkQueryParameter(), 500);

      // Search functionality
      let currentSearchMarker = null;
      const searchResults = document.getElementById("searchResults");

      // Check for query parameter
      function checkQueryParameter() {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get("q");
        if (query) {
          searchInput.value = query;
          performSearch(query);
        }
      }

      async function performSearch(query) {
        if (!query || query.trim() === "") {
          showtoast("Please enter a search query");
          return;
        }

        // Check rate limit for search
        if (!checkRateLimit("search")) {
          return;
        }

        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              query
            )}&limit=20`
          );
          const results = await response.json();

          if (results && results.length > 0) {
            // Clear previous results
            searchResults.innerHTML = "";

            // Hide directions panel and show search results
            directionsPanel.classList.remove("active");
            searchResults.classList.add("active");

            // Display all results as a list
            results.forEach((result, index) => {
              const resultItem = document.createElement("div");
              resultItem.className = "search-result-item";

              const resultTitle = document.createElement("div");
              resultTitle.style.fontWeight = "600";
              resultTitle.style.marginBottom = "0.25rem";
              resultTitle.textContent = result.display_name.split(",")[0];

              const resultAddress = document.createElement("div");
              resultAddress.style.fontSize = "0.75rem";
              resultAddress.style.opacity = "0.7";
              resultAddress.textContent = result.display_name;

              resultItem.appendChild(resultTitle);
              resultItem.appendChild(resultAddress);

              resultItem.addEventListener("click", () => {
                const lat = parseFloat(result.lat);
                const lon = parseFloat(result.lon);

                // Remove previous search marker if exists
                if (currentSearchMarker) {
                  map.removeLayer(currentSearchMarker);
                }

                // Add marker and zoom to location
                currentSearchMarker = L.marker([lat, lon]).addTo(map);
                currentSearchMarker.bindPopup(result.display_name).openPopup();
                map.setView([lat, lon], 15);
                updateCoordinatesDisplay(lat, lon);
              });

              searchResults.appendChild(resultItem);
            });

            showtoast(
              `Found ${results.length} result${results.length > 1 ? "s" : ""}`
            );
          } else {
            searchResults.innerHTML =
              "<div style='padding: 1rem; text-align: center; opacity: 0.6;'>No results found</div>";
            searchResults.classList.add("active");
            directionsPanel.classList.remove("active");
            showtoast("No results found for your search");
          }
        } catch (error) {
          showtoast("Search failed. Please try again.");
          console.error("Search error:", error);
        }
      }

      // Search input event listeners
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          performSearch(searchInput.value);
        }
      });

      // Click on search icon to search
      document
        .querySelector(".search-bar .material-symbols-rounded")
        .addEventListener("click", function () {
          performSearch(searchInput.value);
        });

      // Browser beep sound function using Web Audio API
      function playBeep(duration = 150, frequency = 800) {
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = frequency;
        oscillator.type = "sine";

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + duration / 1000
        );

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
      }

      // Voice search functionality
      const micIcon = document.getElementById("micIcon");
      let recognition = null;

      if (
        "webkitSpeechRecognition" in window ||
        "SpeechRecognition" in window
      ) {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = "en-US";

        recognition.onstart = function () {
          micIcon.style.color = "#f44336";
          searchInput.placeholder = "Listening...";
          playBeep(100, 600); // Start beep
        };

        recognition.onresult = function (event) {
          const transcript = event.results[0][0].transcript;
          searchInput.value = transcript;
          playBeep(100, 800); // Success beep
          performSearch(transcript);
        };

        recognition.onerror = function (event) {
          playBeep(200, 400); // Error beep (lower frequency)
          showtoast("Voice recognition error: " + event.error);
          micIcon.style.color = "";
          searchInput.placeholder = "Search Places, Addresses, Restaurants";
        };

        recognition.onend = function () {
          micIcon.style.color = "";
          searchInput.placeholder = "Search Places, Addresses, Restaurants";
        };

        micIcon.addEventListener("click", function () {
          try {
            recognition.start();
          } catch (error) {
            showtoast("Voice recognition is already active or unavailable");
          }
        });

        micIcon.style.cursor = "pointer";
      } else {
        micIcon.style.opacity = "0.5";
        micIcon.title = "Voice search not supported in this browser";
      }

      // Markers functionality with IndexedDB
      let userMarkers = [];
      const markersModal = document.getElementById("markersModal");
      const markerList = document.getElementById("markerList");

      // IndexedDB for markers
      async function initMarkersDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open("munetios-maps-db", 4);

          request.onupgradeneeded = function (event) {
            const db = event.target.result;
            if (!db.objectStoreNames.contains("markers")) {
              db.createObjectStore("markers", {
                keyPath: "id",
                autoIncrement: true,
              });
            }
            if (!db.objectStoreNames.contains("bookmarks")) {
              db.createObjectStore("bookmarks", {
                keyPath: "id",
                autoIncrement: true,
              });
            }
            if (!db.objectStoreNames.contains("locations")) {
              db.createObjectStore("locations", { keyPath: "id" });
            }
            if (!db.objectStoreNames.contains("keys")) {
              db.createObjectStore("keys", { keyPath: "id" });
            }
          };

          request.onsuccess = (event) => {
            const db = event.target.result;
            // Verify markers store exists
            if (!db.objectStoreNames.contains("markers")) {
              db.close();
              reject(new Error("Markers store not found"));
              return;
            }
            resolve(db);
          };
          request.onerror = () => reject(request.error);
        });
      }

      async function loadMarkers() {
        try {
          const db = await initMarkersDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction("markers", "readonly");
            const store = tx.objectStore("markers");
            const request = store.getAll();

            request.onsuccess = () => {
              userMarkers = request.result;
              resolve(userMarkers);
            };
            request.onerror = () => reject(request.error);
          });
        } catch (error) {
          console.error("Error loading markers:", error);
          userMarkers = [];
          return [];
        }
      }

      async function saveMarker(marker) {
        const db = await initMarkersDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("markers", "readwrite");
          const store = tx.objectStore("markers");
          const request = store.add(marker);

          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      }

      async function deleteMarker(id) {
        const db = await initMarkersDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("markers", "readwrite");
          const store = tx.objectStore("markers");
          const request = store.delete(id);

          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      }

      function renderMarkers() {
        markerList.innerHTML = "";

        if (userMarkers.length === 0) {
          markerList.innerHTML =
            "<div style='padding: 1rem; text-align: center; opacity: 0.6;'>No markers yet. Add one to get started!</div>";
          return;
        }

        userMarkers.forEach((marker) => {
          const item = document.createElement("div");
          item.className = "marker-item";

          const info = document.createElement("div");
          info.className = "marker-info";
          info.onclick = () => {
            map.setView([marker.lat, marker.lng], 15);
            markersModal.classList.remove("active");
            if (marker.leafletMarker) {
              marker.leafletMarker.openPopup();
            }
          };

          const name = document.createElement("div");
          name.className = "marker-name";
          name.textContent = marker.name;

          const coords = document.createElement("div");
          coords.className = "marker-coords";
          coords.textContent = `${marker.lat.toFixed(5)}, ${marker.lng.toFixed(
            5
          )}`;

          info.appendChild(name);
          info.appendChild(coords);

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "marker-delete";
          deleteBtn.innerHTML =
            "<span class='material-symbols-rounded'>delete</span>";
          deleteBtn.onclick = async () => {
            await deleteMarker(marker.id);
            if (marker.leafletMarker) {
              map.removeLayer(marker.leafletMarker);
            }
            await loadMarkers();
            renderMarkers();
            showtoast("Marker deleted");
          };

          item.appendChild(info);
          item.appendChild(deleteBtn);
          markerList.appendChild(item);
        });
      }

      async function displayMarkersOnMap() {
        userMarkers.forEach((marker) => {
          if (marker.leafletMarker) {
            map.removeLayer(marker.leafletMarker);
          }

          const leafletMarker = L.marker([marker.lat, marker.lng]).addTo(map);
          leafletMarker.bindPopup(marker.name);
          marker.leafletMarker = leafletMarker;
        });
      }

      // Markers button
      document.getElementById("markersBtn").addEventListener("click", () => {
        markersModal.classList.add("active");
        renderMarkers();
      });

      document
        .getElementById("closeMarkersModal")
        .addEventListener("click", () => {
          markersModal.classList.remove("active");
        });

      markersModal.addEventListener("click", (e) => {
        if (e.target === markersModal) {
          markersModal.classList.remove("active");
        }
      });

      const addMarkerModal = document.getElementById("addMarkerModal");
      const markerNameInput = document.getElementById("markerNameInput");

      document.getElementById("addMarkerBtn").addEventListener("click", () => {
        addMarkerModal.classList.add("active");
        markerNameInput.value = "";
        markerNameInput.focus();
      });

      document
        .getElementById("cancelAddMarker")
        .addEventListener("click", () => {
          addMarkerModal.classList.remove("active");
        });

      document
        .getElementById("confirmAddMarker")
        .addEventListener("click", async () => {
          const name = markerNameInput.value.trim();

          if (name) {
            const center = map.getCenter();
            const marker = {
              name: name,
              lat: center.lat,
              lng: center.lng,
              timestamp: Date.now(),
            };

            const id = await saveMarker(marker);
            marker.id = id;

            await loadMarkers();
            await displayMarkersOnMap();
            renderMarkers();

            addMarkerModal.classList.remove("active");
            showtoast("Marker added!");
          } else {
            showtoast("Please enter a marker name");
          }
        });

      markerNameInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          document.getElementById("confirmAddMarker").click();
        }
      });

      // Load markers on start
      loadMarkers().then(displayMarkersOnMap);

      // Bookmarks functionality with IndexedDB
      let userBookmarks = [];
      const bookmarksModal = document.getElementById("bookmarksModal");
      const bookmarkList = document.getElementById("bookmarkList");

      // IndexedDB for bookmarks
      async function initBookmarksDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open("munetios-maps-db", 4);

          request.onupgradeneeded = function (event) {
            const db = event.target.result;
            if (!db.objectStoreNames.contains("bookmarks")) {
              db.createObjectStore("bookmarks", {
                keyPath: "id",
                autoIncrement: true,
              });
            }
            if (!db.objectStoreNames.contains("markers")) {
              db.createObjectStore("markers", {
                keyPath: "id",
                autoIncrement: true,
              });
            }
            if (!db.objectStoreNames.contains("locations")) {
              db.createObjectStore("locations", { keyPath: "id" });
            }
            if (!db.objectStoreNames.contains("keys")) {
              db.createObjectStore("keys", { keyPath: "id" });
            }
          };

          request.onsuccess = (event) => {
            resolve(event.target.result);
          };
          request.onerror = () => reject(request.error);
        });
      }

      async function loadBookmarks() {
        try {
          const db = await initBookmarksDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction("bookmarks", "readonly");
            const store = tx.objectStore("bookmarks");
            const request = store.getAll();

            request.onsuccess = () => {
              userBookmarks = request.result;
              resolve(request.result);
            };
            request.onerror = () => reject(request.error);
          });
        } catch (error) {
          console.error("Error loading bookmarks:", error);
          userBookmarks = [];
          return [];
        }
      }

      async function saveBookmark(bookmark) {
        const db = await initBookmarksDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("bookmarks", "readwrite");
          const store = tx.objectStore("bookmarks");
          const request = store.add(bookmark);

          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      }

      async function deleteBookmark(id) {
        const db = await initBookmarksDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("bookmarks", "readwrite");
          const store = tx.objectStore("bookmarks");
          const request = store.delete(id);

          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      }

      function isBookmarked(lat, lng) {
        return userBookmarks.some(
          (b) =>
            Math.abs(b.lat - lat) < 0.0001 && Math.abs(b.lng - lng) < 0.0001
        );
      }

      function renderBookmarks() {
        bookmarkList.innerHTML = "";

        if (userBookmarks.length === 0) {
          bookmarkList.innerHTML =
            "<div style='padding: 1rem; text-align: center; opacity: 0.6;'>No bookmarks yet. Right-click on the map to bookmark a location!</div>";
          return;
        }

        userBookmarks.forEach((bookmark) => {
          const item = document.createElement("div");
          item.className = "marker-item";

          const info = document.createElement("div");
          info.className = "marker-info";
          info.onclick = () => {
            map.setView([bookmark.lat, bookmark.lng], 15);
            bookmarksModal.classList.remove("active");
          };

          const name = document.createElement("div");
          name.className = "marker-name";
          name.textContent = bookmark.name;

          const coords = document.createElement("div");
          coords.className = "marker-coords";
          coords.textContent = `${bookmark.lat.toFixed(
            5
          )}, ${bookmark.lng.toFixed(5)}`;

          info.appendChild(name);
          info.appendChild(coords);

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "marker-delete";
          deleteBtn.innerHTML =
            "<span class='material-symbols-rounded'>delete</span>";
          deleteBtn.onclick = async () => {
            await deleteBookmark(bookmark.id);
            await loadBookmarks();
            renderBookmarks();
            showtoast("Bookmark removed");
          };

          item.appendChild(info);
          item.appendChild(deleteBtn);
          bookmarkList.appendChild(item);
        });
      }

      // Bookmarks button
      document.getElementById("bookmarksBtn").addEventListener("click", () => {
        bookmarksModal.classList.add("active");
        renderBookmarks();
      });

      document
        .getElementById("closeBookmarksModal")
        .addEventListener("click", () => {
          bookmarksModal.classList.remove("active");
        });

      bookmarksModal.addEventListener("click", (e) => {
        if (e.target === bookmarksModal) {
          bookmarksModal.classList.remove("active");
        }
      });

      // Bookmark from context menu
      document
        .getElementById("bookmarkLocation")
        .addEventListener("click", async (e) => {
          e.stopPropagation();
          contextMenu.classList.remove("active");

          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${contextMenuLat}&lon=${contextMenuLng}`
            );
            const data = await response.json();
            const name =
              data.display_name ||
              `${contextMenuLat.toFixed(5)}, ${contextMenuLng.toFixed(5)}`;

            const bookmark = {
              name: name,
              lat: contextMenuLat,
              lng: contextMenuLng,
              timestamp: Date.now(),
            };

            const id = await saveBookmark(bookmark);
            bookmark.id = id;

            await loadBookmarks();
            showtoast("Bookmarked!");
          } catch (error) {
            showtoast("Failed to bookmark location");
          }
        });

      // Load bookmarks on start
      loadBookmarks();

      // Translation system
      const translations = {
        en: {
          settings: "Settings",
          language: "Language",
          deleteAllMarkers: "Delete All Markers",
          selectLanguage: "Select Language",
          confirmDelete: "Confirm Delete",
          deleteAllMarkersConfirm:
            "Are you sure you want to delete all markers? This action cannot be undone.",
          cancel: "Cancel",
          deleteAll: "Delete All",
          myMarkers: "My Markers",
          addMarkerAtLocation: "Add Marker at Current Location",
          bookmarks: "Bookmarks",
          addMarker: "Add Marker",
          enterMarkerName: "Enter marker name",
          add: "Add",
          directions: "Directions",
          markers: "Markers",
          startingPoint: "Starting point",
          destination: "Destination",
          start: "Start",
          feelingLucky: "I'm Feeling Lucky",
          searchPlaceholder: "Search Places, Addresses, Restaurants",
        },
        es: {
          settings: "Configuraci√≥n",
          language: "Idioma",
          deleteAllMarkers: "Eliminar Todos los Marcadores",
          selectLanguage: "Seleccionar Idioma",
          confirmDelete: "Confirmar Eliminaci√≥n",
          deleteAllMarkersConfirm:
            "¬øEst√° seguro de que desea eliminar todos los marcadores? Esta acci√≥n no se puede deshacer.",
          cancel: "Cancelar",
          deleteAll: "Eliminar Todo",
          myMarkers: "Mis Marcadores",
          addMarkerAtLocation: "Agregar Marcador en Ubicaci√≥n Actual",
          bookmarks: "Marcadores",
          addMarker: "Agregar Marcador",
          enterMarkerName: "Ingrese el nombre del marcador",
          add: "Agregar",
          directions: "Direcciones",
          markers: "Marcadores",
          startingPoint: "Punto de partida",
          destination: "Destino",
          start: "Iniciar",
          feelingLucky: "Voy a Tener Suerte",
          searchPlaceholder: "Buscar Lugares, Direcciones, Restaurantes",
        },
        fr: {
          settings: "Param√®tres",
          language: "Langue",
          deleteAllMarkers: "Supprimer Tous les Marqueurs",
          selectLanguage: "S√©lectionner la Langue",
          confirmDelete: "Confirmer la Suppression",
          deleteAllMarkersConfirm:
            "√ätes-vous s√ªr de vouloir supprimer tous les marqueurs? Cette action ne peut pas √™tre annul√©e.",
          cancel: "Annuler",
          deleteAll: "Tout Supprimer",
          myMarkers: "Mes Marqueurs",
          addMarkerAtLocation: "Ajouter un Marqueur √† l'Emplacement Actuel",
          bookmarks: "Favoris",
          addMarker: "Ajouter un Marqueur",
          enterMarkerName: "Entrez le nom du marqueur",
          add: "Ajouter",
          directions: "Directions",
          markers: "Marqueurs",
          startingPoint: "Point de d√©part",
          destination: "Destination",
          start: "D√©marrer",
          feelingLucky: "J'ai de la Chance",
          searchPlaceholder: "Rechercher Lieux, Adresses, Restaurants",
        },
        de: {
          settings: "Einstellungen",
          language: "Sprache",
          deleteAllMarkers: "Alle Markierungen L√∂schen",
          selectLanguage: "Sprache Ausw√§hlen",
          confirmDelete: "L√∂schen Best√§tigen",
          deleteAllMarkersConfirm:
            "Sind Sie sicher, dass Sie alle Markierungen l√∂schen m√∂chten? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.",
          cancel: "Abbrechen",
          deleteAll: "Alle L√∂schen",
          myMarkers: "Meine Markierungen",
          addMarkerAtLocation: "Markierung an Aktuellem Standort Hinzuf√ºgen",
          bookmarks: "Lesezeichen",
          addMarker: "Markierung Hinzuf√ºgen",
          enterMarkerName: "Markierungsname eingeben",
          add: "Hinzuf√ºgen",
          directions: "Richtungen",
          markers: "Markierungen",
          startingPoint: "Ausgangspunkt",
          destination: "Ziel",
          start: "Start",
          feelingLucky: "Auf Gut Gl√ºck",
          searchPlaceholder: "Orte, Adressen, Restaurants Suchen",
        },
        it: {
          settings: "Impostazioni",
          language: "Lingua",
          deleteAllMarkers: "Elimina Tutti i Marcatori",
          selectLanguage: "Seleziona Lingua",
          confirmDelete: "Conferma Eliminazione",
          deleteAllMarkersConfirm:
            "Sei sicuro di voler eliminare tutti i marcatori? Questa azione non pu√≤ essere annullata.",
          cancel: "Annulla",
          deleteAll: "Elimina Tutto",
          myMarkers: "I Miei Marcatori",
          addMarkerAtLocation: "Aggiungi Marcatore alla Posizione Corrente",
          bookmarks: "Segnalibri",
          addMarker: "Aggiungi Marcatore",
          enterMarkerName: "Inserisci il nome del marcatore",
          add: "Aggiungi",
          directions: "Indicazioni",
          markers: "Marcatori",
          startingPoint: "Punto di partenza",
          destination: "Destinazione",
          start: "Avvia",
          feelingLucky: "Mi Sento Fortunato",
          searchPlaceholder: "Cerca Luoghi, Indirizzi, Ristoranti",
        },
        pt: {
          settings: "Configura√ß√µes",
          language: "Idioma",
          deleteAllMarkers: "Excluir Todos os Marcadores",
          selectLanguage: "Selecionar Idioma",
          confirmDelete: "Confirmar Exclus√£o",
          deleteAllMarkersConfirm:
            "Tem certeza de que deseja excluir todos os marcadores? Esta a√ß√£o n√£o pode ser desfeita.",
          cancel: "Cancelar",
          deleteAll: "Excluir Tudo",
          myMarkers: "Meus Marcadores",
          addMarkerAtLocation: "Adicionar Marcador na Localiza√ß√£o Atual",
          bookmarks: "Favoritos",
          addMarker: "Adicionar Marcador",
          enterMarkerName: "Digite o nome do marcador",
          add: "Adicionar",
          directions: "Dire√ß√µes",
          markers: "Marcadores",
          startingPoint: "Ponto de partida",
          destination: "Destino",
          start: "Iniciar",
          feelingLucky: "Estou com Sorte",
          searchPlaceholder: "Pesquisar Lugares, Endere√ßos, Restaurantes",
        },
        ja: {
          settings: "Ë®≠ÂÆö",
          language: "Ë®ÄË™û",
          deleteAllMarkers: "„Åô„Åπ„Å¶„ÅÆ„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§",
          selectLanguage: "Ë®ÄË™û„ÇíÈÅ∏Êäû",
          confirmDelete: "ÂâäÈô§„ÅÆÁ¢∫Ë™ç",
          deleteAllMarkersConfirm:
            "„Åô„Åπ„Å¶„ÅÆ„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ",
          cancel: "„Ç≠„É£„É≥„Çª„É´",
          deleteAll: "„Åô„Åπ„Å¶ÂâäÈô§",
          myMarkers: "„Éû„Ç§„Éû„Éº„Ç´„Éº",
          addMarkerAtLocation: "ÁèæÂú®Âú∞„Å´„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†",
          bookmarks: "„Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØ",
          addMarker: "„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†",
          enterMarkerName: "„Éû„Éº„Ç´„ÉºÂêç„ÇíÂÖ•Âäõ",
          add: "ËøΩÂä†",
          directions: "ÈÅìÈ†Ü",
          markers: "„Éû„Éº„Ç´„Éº",
          startingPoint: "Âá∫Áô∫Âú∞",
          destination: "ÁõÆÁöÑÂú∞",
          start: "ÈñãÂßã",
          feelingLucky: "Ê∞ó„Åæ„Åê„ÇåÊ§úÁ¥¢",
          searchPlaceholder: "Â†¥ÊâÄ„ÄÅ‰ΩèÊâÄ„ÄÅ„É¨„Çπ„Éà„É©„É≥„ÇíÊ§úÁ¥¢",
        },
        zh: {
          settings: "ËÆæÁΩÆ",
          language: "ËØ≠Ë®Ä",
          deleteAllMarkers: "Âà†Èô§ÊâÄÊúâÊ†áËÆ∞",
          selectLanguage: "ÈÄâÊã©ËØ≠Ë®Ä",
          confirmDelete: "Á°ÆËÆ§Âà†Èô§",
          deleteAllMarkersConfirm: "ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâÊ†áËÆ∞ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§Ê∂à„ÄÇ",
          cancel: "ÂèñÊ∂à",
          deleteAll: "ÂÖ®ÈÉ®Âà†Èô§",
          myMarkers: "ÊàëÁöÑÊ†áËÆ∞",
          addMarkerAtLocation: "Âú®ÂΩìÂâç‰ΩçÁΩÆÊ∑ªÂä†Ê†áËÆ∞",
          bookmarks: "‰π¶Á≠æ",
          addMarker: "Ê∑ªÂä†Ê†áËÆ∞",
          enterMarkerName: "ËæìÂÖ•Ê†áËÆ∞ÂêçÁß∞",
          add: "Ê∑ªÂä†",
          directions: "ÊñπÂêë",
          markers: "Ê†áËÆ∞",
          startingPoint: "Ëµ∑ÁÇπ",
          destination: "ÁõÆÁöÑÂú∞",
          start: "ÂºÄÂßã",
          feelingLucky: "ÊâãÊ∞î‰∏çÈîô",
          searchPlaceholder: "ÊêúÁ¥¢Âú∞ÁÇπ„ÄÅÂú∞ÂùÄ„ÄÅÈ§êÂéÖ",
        },
        ar: {
          settings: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™",
          language: "ÿßŸÑŸÑÿ∫ÿ©",
          deleteAllMarkers: "ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™",
          selectLanguage: "ÿßÿÆÿ™ÿ± ÿßŸÑŸÑÿ∫ÿ©",
          confirmDelete: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ",
          deleteAllMarkersConfirm:
            "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ±ÿ∫ÿ®ÿ™ŸÉ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.",
          cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
          deleteAll: "ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉŸÑ",
          myMarkers: "ÿπŸÑÿßŸÖÿßÿ™Ÿä",
          addMarkerAtLocation: "ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ŸÅŸä ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ≠ÿßŸÑŸä",
          bookmarks: "ÿßŸÑÿ•ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ±ÿ¨ÿπŸäÿ©",
          addMarker: "ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ©",
          enterMarkerName: "ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπŸÑÿßŸÖÿ©",
          add: "ÿ•ÿ∂ÿßŸÅÿ©",
          directions: "ÿßŸÑÿßÿ™ÿ¨ÿßŸáÿßÿ™",
          markers: "ÿπŸÑÿßŸÖÿßÿ™",
          startingPoint: "ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ©",
          destination: "ÿßŸÑŸàÿ¨Ÿáÿ©",
          start: "ÿßÿ®ÿØÿ£",
          feelingLucky: "ÿ£ÿ¥ÿπÿ± ÿ®ÿßŸÑÿ≠ÿ∏",
          searchPlaceholder: "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸÖÿßŸÉŸÜ ŸàÿπŸÜÿßŸàŸäŸÜ ŸàŸÖÿ∑ÿßÿπŸÖ",
        },
        hi: {
          settings: "‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏",
          language: "‡§≠‡§æ‡§∑‡§æ",
          deleteAllMarkers: "‡§∏‡§≠‡•Ä ‡§Æ‡§æ‡§∞‡•ç‡§ï‡§∞ ‡§π‡§ü‡§æ‡§è‡§Ç",
          selectLanguage: "‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç",
          confirmDelete: "‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç",
          deleteAllMarkersConfirm:
            "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∏‡§≠‡•Ä ‡§Æ‡§æ‡§∞‡•ç‡§ï‡§∞ ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§µ‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§",
          cancel: "‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
          deleteAll: "‡§∏‡§≠‡•Ä ‡§π‡§ü‡§æ‡§è‡§Ç",
          myMarkers: "‡§Æ‡•á‡§∞‡•á ‡§Æ‡§æ‡§∞‡•ç‡§ï‡§∞",
          addMarkerAtLocation: "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§∞ ‡§Æ‡§æ‡§∞‡•ç‡§ï‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
          bookmarks: "‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï",
          addMarker: "‡§Æ‡§æ‡§∞‡•ç‡§ï‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
          enterMarkerName: "‡§Æ‡§æ‡§∞‡•ç‡§ï‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
          add: "‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
          directions: "‡§¶‡§ø‡§∂‡§æ-‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂",
          markers: "‡§Æ‡§æ‡§∞‡•ç‡§ï‡§∞",
          startingPoint: "‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§¨‡§ø‡§Ç‡§¶‡•Å",
          destination: "‡§ó‡§Ç‡§§‡§µ‡•ç‡§Ø",
          start: "‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç",
          feelingLucky: "‡§≠‡§æ‡§ó‡•ç‡§Ø‡§∂‡§æ‡§≤‡•Ä ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å",
          searchPlaceholder: "‡§∏‡•ç‡§•‡§æ‡§®, ‡§™‡§§‡§æ, ‡§∞‡•á‡§∏‡•ç‡§§‡§∞‡§æ‡§Ç ‡§ñ‡•ã‡§ú‡•á‡§Ç",
        },
      };

      let currentLanguage =
        localStorage.getItem("munetios-maps-language") || "en";

      function translateUI(lang) {
        const trans = translations[lang] || translations.en;

        // Translate all elements with data-i18n attribute
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          if (trans[key]) {
            el.textContent = trans[key];
          }
        });

        // Update placeholders
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
          searchInput.placeholder = trans.searchPlaceholder;
        }

        const markerNameInput = document.getElementById("markerNameInput");
        if (markerNameInput) {
          markerNameInput.placeholder = trans.enterMarkerName;
        }

        const fromInput = document.getElementById("fromInput");
        if (fromInput) {
          fromInput.placeholder = trans.startingPoint;
        }

        const toInput = document.getElementById("toInput");
        if (toInput) {
          toInput.placeholder = trans.destination;
        }

        // Update current language text
        const languageNames = {
          en: "English",
          es: "Espa√±ol",
          fr: "Fran√ßais",
          de: "Deutsch",
          it: "Italiano",
          pt: "Portugu√™s",
          ja: "Êó•Êú¨Ë™û",
          zh: "‰∏≠Êñá",
          ar: "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©",
          hi: "‡§π‡§ø‡§®‡•ç‡§¶‡•Ä",
        };

        const currentLanguageText = document.getElementById(
          "currentLanguageText"
        );
        if (currentLanguageText) {
          currentLanguageText.textContent = languageNames[lang] || "English";
        }
      }

      // Apply saved language on load
      translateUI(currentLanguage);

      // Language modal functionality
      const languageModal = document.getElementById("languageModal");

      document
        .getElementById("selectLanguageBtn")
        .addEventListener("click", () => {
          settingsModal.classList.remove("active");
          languageModal.classList.add("active");

          // Update active language in list
          document.querySelectorAll(".language-item").forEach((item) => {
            item.classList.toggle(
              "active",
              item.dataset.lang === currentLanguage
            );
          });
        });

      document
        .getElementById("closeLanguageModal")
        .addEventListener("click", () => {
          languageModal.classList.remove("active");
        });

      languageModal.addEventListener("click", (e) => {
        if (e.target === languageModal) {
          languageModal.classList.remove("active");
        }
      });

      // Language selection
      document.querySelectorAll(".language-item").forEach((item) => {
        item.addEventListener("click", () => {
          const lang = item.dataset.lang;
          currentLanguage = lang;
          localStorage.setItem("munetios-maps-language", lang);

          // Update UI
          translateUI(lang);

          // Update active state
          document.querySelectorAll(".language-item").forEach((i) => {
            i.classList.toggle("active", i.dataset.lang === lang);
          });

          // Close modal
          languageModal.classList.remove("active");

          const languageName = item.querySelector(".language-name").textContent;
          showtoast(`Language changed to ${languageName}`);
        });
      });

      // Settings functionality
      const settingsModal = document.getElementById("settingsModal");
      const confirmDeleteModal = document.getElementById("confirmDeleteModal");

      document.getElementById("settingsBtn").addEventListener("click", () => {
        settingsModal.classList.add("active");
      });

      document
        .getElementById("closeSettingsModal")
        .addEventListener("click", () => {
          settingsModal.classList.remove("active");
        });

      settingsModal.addEventListener("click", (e) => {
        if (e.target === settingsModal) {
          settingsModal.classList.remove("active");
        }
      });

      // Delete all markers with confirmation
      document
        .getElementById("deleteAllMarkersBtn")
        .addEventListener("click", () => {
          settingsModal.classList.remove("active");
          confirmDeleteModal.classList.add("active");
        });

      document
        .getElementById("cancelDeleteAll")
        .addEventListener("click", () => {
          confirmDeleteModal.classList.remove("active");
        });

      document
        .getElementById("confirmDeleteAll")
        .addEventListener("click", async () => {
          try {
            const db = await initMarkersDB();
            const tx = db.transaction("markers", "readwrite");
            const store = tx.objectStore("markers");
            await store.clear();

            // Remove all markers from map
            userMarkers.forEach((marker) => {
              if (marker.leafletMarker) {
                map.removeLayer(marker.leafletMarker);
              }
            });

            userMarkers = [];
            renderMarkers();
            confirmDeleteModal.classList.remove("active");
            showtoast("All markers deleted");
          } catch (error) {
            showtoast("Failed to delete markers");
            console.error(error);
          }
        });

      confirmDeleteModal.addEventListener("click", (e) => {
        if (e.target === confirmDeleteModal) {
          confirmDeleteModal.classList.remove("active");
        }
      });

      // Directions functionality
      let directionsRoute = null;
      let fromMarker = null;
      let toMarker = null;
      let selectedMode = "driving";
      let speechSynthesis = window.speechSynthesis;
      let currentTurnIndex = 0;
      let directionsData = null;

      const directionsPanel = document.getElementById("directionsPanel");
      const directionsBtn = document.getElementById("directionsBtn");
      const fromInput = document.getElementById("fromInput");
      const toInput = document.getElementById("toInput");
      const startDirectionsBtn = document.getElementById("startDirectionsBtn");
      const stopDirectionsBtn = document.getElementById("stopDirectionsBtn");
      const turnsList = document.getElementById("turnsList");

      directionsBtn.addEventListener("click", () => {
        const isActive = directionsPanel.classList.toggle("active");
        searchResults.classList.remove("active");

        // Show draggable A and B markers when opening directions
        if (isActive) {
          const center = map.getCenter();
          const offset = 0.01;

          if (!fromMarker) {
            fromMarker = L.marker([center.lat - offset, center.lng], {
              draggable: true,
              icon: L.divIcon({
                html: '<div style="background: #4CAF50; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">A</div>',
                className: "",
                iconSize: [30, 30],
              }),
            }).addTo(map);

            fromMarker.on("dragend", async function () {
              const pos = fromMarker.getLatLng();
              const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lng}`
              );
              const data = await response.json();
              fromInput.value =
                data.display_name ||
                `${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`;
            });
          }

          if (!toMarker) {
            toMarker = L.marker([center.lat + offset, center.lng], {
              draggable: true,
              icon: L.divIcon({
                html: '<div style="background: #F44336; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">B</div>',
                className: "",
                iconSize: [30, 30],
              }),
            }).addTo(map);

            toMarker.on("dragend", async function () {
              const pos = toMarker.getLatLng();
              const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lng}`
              );
              const data = await response.json();
              toInput.value =
                data.display_name ||
                `${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`;
            });
          }
        }
      });

      // Transport mode selection
      document.querySelectorAll(".transport-mode").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".transport-mode")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          selectedMode = btn.dataset.mode;
        });
      });

      async function geocodeAddress(address) {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            address
          )}&limit=1`
        );
        const results = await response.json();
        if (results && results.length > 0) {
          return {
            lat: parseFloat(results[0].lat),
            lng: parseFloat(results[0].lon),
          };
        }
        return null;
      }

      async function getDirections(from, to, mode) {
        // Using OSRM for routing
        const profile =
          mode === "driving" ? "car" : mode === "walking" ? "foot" : "bike";
        const url = `https://router.project-osrm.org/route/v1/${profile}/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&steps=true`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.code === "Ok") {
          return data;
        }
        return null;
      }

      let voiceEnabled = true;
      const voiceToggle = document.getElementById("voiceToggle");
      const directionsHeader = document.getElementById("directionsHeader");

      if (voiceToggle) {
        voiceToggle.addEventListener("click", () => {
          voiceEnabled = !voiceEnabled;
          voiceToggle.classList.toggle("active", voiceEnabled);
          voiceToggle.querySelector(".material-symbols-rounded").textContent =
            voiceEnabled ? "volume_up" : "volume_off";

          if (!voiceEnabled) {
            speechSynthesis.cancel();
          }
        });
      }

      function speak(text) {
        if (speechSynthesis && voiceEnabled) {
          speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.rate = 0.9;
          utterance.pitch = 1;
          speechSynthesis.speak(utterance);
        }
      }

      startDirectionsBtn.addEventListener("click", async () => {
        const fromAddress = fromInput.value.trim();
        const toAddress = toInput.value.trim();

        if (!fromAddress || !toAddress) {
          showtoast("Please enter both starting point and destination");
          return;
        }

        // Check rate limit for directions
        if (!checkRateLimit("directions")) {
          return;
        }

        showtoast("Calculating route...");

        try {
          const fromCoords = await geocodeAddress(fromAddress);
          const toCoords = await geocodeAddress(toAddress);

          if (!fromCoords || !toCoords) {
            showtoast("Could not find one or both locations");
            return;
          }

          // Add markers
          if (fromMarker) map.removeLayer(fromMarker);
          if (toMarker) map.removeLayer(toMarker);

          fromMarker = L.marker([fromCoords.lat, fromCoords.lng], {
            draggable: false,
            icon: L.divIcon({
              html: '<div style="background: #4CAF50; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">A</div>',
              className: "",
              iconSize: [30, 30],
            }),
          }).addTo(map);

          toMarker = L.marker([toCoords.lat, toCoords.lng], {
            draggable: false,
            icon: L.divIcon({
              html: '<div style="background: #F44336; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">B</div>',
              className: "",
              iconSize: [30, 30],
            }),
          }).addTo(map);

          directionsData = await getDirections(
            fromCoords,
            toCoords,
            selectedMode
          );

          if (!directionsData) {
            showtoast("Could not calculate route");
            return;
          }

          // Draw route
          if (directionsRoute) {
            map.removeLayer(directionsRoute);
          }

          const route = directionsData.routes[0];
          const coordinates = polyline.decode(route.geometry);

          directionsRoute = L.polyline(coordinates, {
            color: "#2196F3",
            weight: 5,
            opacity: 0.7,
          }).addTo(map);

          map.fitBounds(directionsRoute.getBounds(), { padding: [50, 50] });

          // Display turns
          turnsList.innerHTML = "";
          const steps = route.legs[0].steps;

          steps.forEach((step, index) => {
            const turnItem = document.createElement("div");
            turnItem.className = "turn-item";

            const icon = document.createElement("span");
            icon.className = "material-symbols-rounded turn-icon";
            icon.textContent = getTurnIcon(step.maneuver.type);

            const text = document.createElement("div");
            text.className = "turn-text";
            text.textContent =
              step.maneuver.instruction ||
              `Continue for ${(step.distance / 1000).toFixed(1)} km`;

            const distance = document.createElement("div");
            distance.className = "turn-distance";
            distance.textContent =
              step.distance > 1000
                ? `${(step.distance / 1000).toFixed(1)} km`
                : `${Math.round(step.distance)} m`;

            turnItem.appendChild(icon);
            turnItem.appendChild(text);
            turnItem.appendChild(distance);
            turnsList.appendChild(turnItem);
          });

          // Calculate arrival time
          const duration = Math.round(route.duration / 60);
          const distance = (route.distance / 1000).toFixed(1);
          const now = new Date();
          const arrivalTime = new Date(now.getTime() + route.duration * 1000);
          const arrivalString = arrivalTime.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });

          // Update directions header
          document.getElementById(
            "directionsDuration"
          ).textContent = `${duration} min (${distance} km)`;
          document.getElementById(
            "directionsArrival"
          ).textContent = `Arrival: ${arrivalString}`;
          directionsHeader.style.display = "flex";

          // Start voice navigation
          speak(
            `Starting directions to point B. The trip will take approximately ${duration} minutes and cover ${distance} kilometers.`
          );

          startDirectionsBtn.style.display = "none";

          showtoast(`Route calculated: ${distance} km, ${duration} min`);
        } catch (error) {
          console.error("Directions error:", error);
          showtoast("Failed to calculate directions");
        }
      });

      stopDirectionsBtn.addEventListener("click", () => {
        if (directionsRoute) {
          map.removeLayer(directionsRoute);
        }
        if (fromMarker) map.removeLayer(fromMarker);
        if (toMarker) map.removeLayer(toMarker);

        fromMarker = null;
        toMarker = null;

        speechSynthesis.cancel();
        turnsList.innerHTML = "";
        directionsHeader.style.display = "none";

        startDirectionsBtn.style.display = "flex";

        speak("Navigation stopped");
        showtoast("Navigation stopped");
      });

      // I'm Feeling Lucky button
      document
        .getElementById("feelingLuckyBtn")
        .addEventListener("click", async () => {
          showtoast("Picking a random destination...");

          // Famous places around the world
          const randomPlaces = [
            { name: "Eiffel Tower, Paris", lat: 48.8584, lng: 2.2945 },
            {
              name: "Statue of Liberty, New York",
              lat: 40.6892,
              lng: -74.0445,
            },
            { name: "Big Ben, London", lat: 51.5007, lng: -0.1246 },
            { name: "Colosseum, Rome", lat: 41.8902, lng: 12.4922 },
            { name: "Great Wall of China", lat: 40.4319, lng: 116.5704 },
            { name: "Taj Mahal, India", lat: 27.1751, lng: 78.0421 },
            { name: "Sydney Opera House", lat: -33.8568, lng: 151.2153 },
            {
              name: "Christ the Redeemer, Brazil",
              lat: -22.9519,
              lng: -43.2105,
            },
            { name: "Machu Picchu, Peru", lat: -13.1631, lng: -72.545 },
            { name: "Pyramids of Giza, Egypt", lat: 29.9792, lng: 31.1342 },
            { name: "Mount Fuji, Japan", lat: 35.3606, lng: 138.7274 },
            { name: "Santorini, Greece", lat: 36.3932, lng: 25.4615 },
            { name: "Grand Canyon, USA", lat: 36.1069, lng: -112.1129 },
            { name: "Niagara Falls", lat: 43.0828, lng: -79.0741 },
            { name: "Dubai Marina", lat: 25.0801, lng: 55.1397 },
            { name: "Golden Gate Bridge", lat: 37.8199, lng: -122.4783 },
            { name: "Burj Khalifa, Dubai", lat: 25.1972, lng: 55.2744 },
            { name: "Sagrada Familia, Barcelona", lat: 41.4036, lng: 2.1744 },
            { name: "Petra, Jordan", lat: 30.3285, lng: 35.4444 },
            { name: "Stonehenge, England", lat: 51.1789, lng: -1.8262 },
          ];

          const randomIndex = Math.floor(Math.random() * randomPlaces.length);
          const destination = randomPlaces[randomIndex];

          // Use current location or map center as starting point
          const center = map.getCenter();
          fromInput.value = `${center.lat.toFixed(5)}, ${center.lng.toFixed(
            5
          )}`;
          toInput.value = destination.name;

          // Update markers
          if (fromMarker) map.removeLayer(fromMarker);
          if (toMarker) map.removeLayer(toMarker);

          fromMarker = L.marker([center.lat, center.lng], {
            draggable: true,
            icon: L.divIcon({
              html: '<div style="background: #4CAF50; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">A</div>',
              className: "",
              iconSize: [30, 30],
            }),
          }).addTo(map);

          toMarker = L.marker([destination.lat, destination.lng], {
            draggable: true,
            icon: L.divIcon({
              html: '<div style="background: #F44336; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">B</div>',
              className: "",
              iconSize: [30, 30],
            }),
          }).addTo(map);

          showtoast(`Lucky destination: ${destination.name}!`);

          // Automatically start directions
          setTimeout(() => {
            startDirectionsBtn.click();
          }, 1000);
        });

      function getTurnIcon(type) {
        const icons = {
          turn: "turn_right",
          "new name": "straight",
          depart: "north",
          arrive: "flag",
          merge: "merge",
          "on ramp": "ramp_right",
          "off ramp": "ramp_left",
          fork: "fork_right",
          "end of road": "turn_slight_right",
          continue: "straight",
          roundabout: "roundabout_right",
          rotary: "roundabout_right",
          "roundabout turn": "roundabout_right",
        };
        return icons[type] || "navigation";
      }

      // Polyline decoder
      const polyline = {
        decode: function (str, precision) {
          let index = 0,
            lat = 0,
            lng = 0,
            coordinates = [],
            shift = 0,
            result = 0,
            byte = null,
            latitude_change,
            longitude_change,
            factor = Math.pow(10, precision || 5);

          while (index < str.length) {
            byte = null;
            shift = 0;
            result = 0;

            do {
              byte = str.charCodeAt(index++) - 63;
              result |= (byte & 0x1f) << shift;
              shift += 5;
            } while (byte >= 0x20);

            latitude_change = result & 1 ? ~(result >> 1) : result >> 1;
            shift = result = 0;

            do {
              byte = str.charCodeAt(index++) - 63;
              result |= (byte & 0x1f) << shift;
              shift += 5;
            } while (byte >= 0x20);

            longitude_change = result & 1 ? ~(result >> 1) : result >> 1;
            lat += latitude_change;
            lng += longitude_change;
            coordinates.push([lat / factor, lng / factor]);
          }

          return coordinates;
        },
      };

      // "Use My Location" button functionality with E2E encryption and IndexedDB storage

      // Simple AES-GCM encryption helpers using Web Crypto API
      async function generateKey() {
        return await window.crypto.subtle.generateKey(
          { name: "AES-GCM", length: 256 },
          true,
          ["encrypt", "decrypt"]
        );
      }

      async function encryptData(key, data) {
        const enc = new TextEncoder();
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const ciphertext = await window.crypto.subtle.encrypt(
          { name: "AES-GCM", iv },
          key,
          enc.encode(JSON.stringify(data))
        );
        return {
          iv: Array.from(iv),
          ciphertext: Array.from(new Uint8Array(ciphertext)),
        };
      }

      async function saveToIndexedDB(keyObj, encryptedData) {
        return new Promise((resolve, reject) => {
          // First, open the DB to check if both stores exist; if not, upgrade
          const dbName = "munetios-maps-db";
          const storeNames = ["locations", "keys"];
          let dbVersion = 1;

          // Check current version and stores
          const checkRequest = indexedDB.open(dbName);
          checkRequest.onsuccess = function (event) {
            const db = event.target.result;
            let needsUpgrade = false;
            storeNames.forEach((name) => {
              if (!db.objectStoreNames.contains(name)) {
                needsUpgrade = true;
              }
            });
            dbVersion = db.version;
            db.close();

            if (needsUpgrade) {
              // Upgrade DB to add missing stores
              const upgradeRequest = indexedDB.open(dbName, dbVersion + 1);
              upgradeRequest.onupgradeneeded = function (event) {
                const upDb = event.target.result;
                storeNames.forEach((name) => {
                  if (!upDb.objectStoreNames.contains(name)) {
                    upDb.createObjectStore(name, { keyPath: "id" });
                  }
                });
              };
              upgradeRequest.onsuccess = function () {
                // After upgrade, call saveToIndexedDB again
                saveToIndexedDB(keyObj, encryptedData)
                  .then(resolve)
                  .catch(reject);
              };
              upgradeRequest.onerror = function (e) {
                reject(e);
              };
            } else {
              // All stores exist, proceed to save
              const request = indexedDB.open(dbName, dbVersion);
              request.onsuccess = function (event) {
                const db = event.target.result;
                const tx = db.transaction(storeNames, "readwrite");
                const locationsStore = tx.objectStore("locations");
                const keysStore = tx.objectStore("keys");
                // Save encrypted location
                locationsStore.put({ id: "lastLocation", ...encryptedData });
                // Export and save key
                window.crypto.subtle.exportKey("jwk", keyObj).then((jwk) => {
                  keysStore.put({ id: "locationKey", jwk });
                  tx.oncomplete = () => resolve();
                  tx.onerror = (e) => reject(e);
                });
              };
              request.onerror = function (e) {
                reject(e);
              };
            }
          };
          checkRequest.onerror = function (e) {
            reject(e);
          };
        });
      }

      document
        .getElementById("useMyLocationBtn")
        .addEventListener("click", async function () {
          if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser.");
            return;
          }
          navigator.geolocation.getCurrentPosition(
            async function (position) {
              const { latitude, longitude } = position.coords;
              map.setView([latitude, longitude], 14);
              updateCoordinatesDisplay(latitude, longitude);

              // Remove previous blue dot if it exists
              if (window._munetiosBlueDot) {
                map.removeLayer(window._munetiosBlueDot);
              }
              // Add blue dot marker
              window._munetiosBlueDot = L.circleMarker([latitude, longitude], {
                radius: 8,
                color: "#1976d2",
                fillColor: "#2196f3",
                fillOpacity: 0.9,
                weight: 2,
              }).addTo(map);

              // E2E encrypt and save to IndexedDB
              try {
                const key = await generateKey();
                const encrypted = await encryptData(key, {
                  latitude,
                  longitude,
                  timestamp: Date.now(),
                });
                await saveToIndexedDB(key, encrypted);
              } catch (e) {
                alert("Failed to securely save your location.");
              }
            },
            function () {
              alert("Unable to retrieve your location.");
            }
          );
        });
      /**
       * Shuffle all attributes starting with _ng-content- on elements in the document.
       * This randomizes their values to avoid static IDs.
       */
      (function shuffleNgContentAttributes() {
        function randomId(len = 8) {
          const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
          let id = "";
          for (let i = 0; i < len; i++) {
            id += chars.charAt(Math.floor(Math.random() * chars.length));
          }
          return id;
        }

        function shuffleAttributes(element) {
          Array.from(element.attributes).forEach((attr) => {
            if (attr.name.startsWith("_ng-content-")) {
              element.setAttribute(attr.name, randomId(12));
            }
          });
          Array.from(element.children).forEach(shuffleAttributes);
        }

        shuffleAttributes(document.body);
      })();
      // Overwrite alert() to use showtoast instead
      function showtoast(message) {
        // Simple toast implementation
        let toast = document.createElement("div");
        toast.textContent = message;
        toast.className = "liquid-glass";
        toast.style.position = "fixed";
        toast.style.bottom = "2rem";
        toast.style.left = "50%";
        toast.style.transform = "translateX(-50%)";
        toast.style.padding = "0.75rem 1.5rem";
        toast.style.borderRadius = "1.5rem";
        toast.style.fontSize = "1rem";
        toast.style.zIndex = "99999999999";
        toast.style.pointerEvents = "none";
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.transition = "opacity 0.4s";
          toast.style.opacity = "0";
        }, 2200);
        setTimeout(() => {
          if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 2600);
      }
      window.alert = showtoast;
    </script>
  </body>
</html>
